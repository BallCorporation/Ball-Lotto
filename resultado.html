<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resultado do Sorteio</title>

<style>
:root {
  --blue1: #0038a8;
  --blue2: #0f4fdc;
  --blue3: #4f8dff;
  --white: #ffffff;
}

/* FULL SCREEN */
body {
  margin: 0;
  padding: 0;
  background: #000814;
  color: white;
  height: 100vh;
  font-family: Arial, sans-serif;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 20px;
}

#arena {
  width: 100%;
  max-width: 900px;
  height: 300px;
  background: #001226;
  border-radius: 16px;
  border: 1px solid #2a3b5f;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  overflow: hidden;
}

/* BOT√ïES */
.btn {
  padding: 12px 26px;
  border-radius: 10px;
  border: 2px solid #0f4fdc;
  background: #ffffff;
  color: #0f4fdc;
  font-size: 1rem;
  font-weight: bold;
  cursor: pointer;
  display: none;
  margin: 5px;
  transition: 0.2s;
}

.btn:hover {
  background: #dbe8ff;
}

#botoes {
  display: flex;
  gap: 12px;
}

/* LATAS (RESULTADO FINAL) */
.final-can {
  position: relative;
  width: 90px;
  height: 150px;
  border-radius: 30px;
  margin: 10px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background-image: linear-gradient(90deg,
    var(--blue1), var(--blue2), var(--blue3), var(--blue2), var(--blue1));
  color: white;
  font-size: 2rem;
  font-weight: bold;
  animation: pop 0.4s ease-out forwards;
}

/* TAMPA */
.final-can::before {
  content: "";
  position: absolute;
  top: -8px;
  left: 10px;
  right: 10px;
  height: 14px;
  border-radius: 999px;
  background: radial-gradient(circle at 50% 0,
    var(--white), #e5e7eb 40%, #9ca3af 70%, #4b5563 100%);
}

/* LOGO */
.final-can img.ball-logo {
  width: 50%;
  margin-bottom: 6px;
  filter: drop-shadow(0 0 3px #000);
}

/* NUMERO */
.final-can .num {
  margin: 0;
}

/* ANIMA√á√ÉO */
.spin-can {
  position: absolute;
  width: 65px;
  height: 120px;
  border-radius: 26px;
  opacity: 0;
  background-image: linear-gradient(90deg,
    var(--blue1), var(--blue2), var(--blue3), var(--blue2), var(--blue1));
  animation: spin 0.3s linear forwards;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: white;
  font-size: 1.2rem;
}

/* TAMPA */
.spin-can::before {
  content: "";
  position: absolute;
  top: -6px;
  left: 8px;
  right: 8px;
  height: 12px;
  border-radius: 999px;
  background: radial-gradient(circle at 50% 0,
    var(--white), #e5e7eb 40%, #9ca3af 70%, #4b5563 100%);
}

.spin-can img.ball-logo {
  width: 45%;
  margin-bottom: 4px;
  filter: drop-shadow(0 0 2px #000);
}

.spin-can .num {
  margin: 0;
}

@keyframes spin {
  0% { opacity: 0; transform: scale(0.3) rotate(0deg); }
  50% { opacity: 1; transform: scale(1.1) rotate(180deg); }
  100% { opacity: 0; transform: scale(0.3) rotate(360deg); }
}

@keyframes pop {
  from { transform: scale(0.3); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
</style>
</head>

<body>

<div id="arena"></div>

<div id="botoes">
  <button id="retry" class="btn" onclick="sortearDeNovo()">üîÅ Sortear</button>
  <button id="reset" class="btn" onclick="resetar()">‚ôª Resetar n√∫meros</button>
  <button id="back" class="btn" onclick="voltar()">‚¨Ö Voltar</button>
</div>

<script>
let audioCtx = null;
let noRepeatFlag = 0;
let usedSet = new Set();
let nextSearch = null;

function getParam(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}

function getParamInt(name) {
  const v = getParam(name);
  return v === null ? null : parseInt(v);
}

function random(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function tambor() {
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.frequency.value = 120;
    gain.gain.setValueAtTime(0.8, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.2);
  } catch(e){}
}

async function animacao(tempo) {
  const arena = document.getElementById("arena");

  const loop = setInterval(() => {
    const div = document.createElement("div");
    div.className = "spin-can";

    const logo = document.createElement("img");
    logo.src = "ball-logo.png";
    logo.className = "ball-logo";

    const num = document.createElement("div");
    num.className = "num";
    num.textContent = random(1, 99);

    div.appendChild(logo);
    div.appendChild(num);

    div.style.left = random(10, arena.clientWidth - 80) + "px";
    div.style.top  = random(10, arena.clientHeight - 130) + "px";

    arena.appendChild(div);
    tambor();

    setTimeout(() => div.remove(), 260);
  }, 80);

  return new Promise(resolve => {
    setTimeout(() => {
      clearInterval(loop);
      arena.innerHTML = "";
      resolve();
    }, tempo * 1000);
  });
}

async function iniciar() {
  const min   = getParamInt("min");
  const max   = getParamInt("max");
  const qtd   = getParamInt("qtd");
  const tempo = getParamInt("tempo");
  noRepeatFlag = getParamInt("noRepeat") === 1 ? 1 : 0;

  if (noRepeatFlag) {
    const usadosStr = getParam("usados");
    if (usadosStr) {
      usadosStr.split(",").forEach(v => {
        const n = parseInt(v);
        if (!isNaN(n)) usedSet.add(n);
      });
    }
  }

  await animacao(tempo);

  const arena = document.getElementById("arena");

  const totalIntervalo = max - min + 1;
  const disponiveis = noRepeatFlag ? (totalIntervalo - usedSet.size) : totalIntervalo;

  if (noRepeatFlag && disponiveis < qtd) {
    arena.textContent = "N√£o h√° n√∫meros suficientes.";
    document.getElementById("back").style.display = "inline-block";
    document.getElementById("retry").style.display = "none";
    document.getElementById("reset").style.display = "inline-block";
    return;
  }

  const usadosRodada = new Set();
  const nums = [];

  while (nums.length < qtd) {
    const n = random(min, max);
    if ((noRepeatFlag && usedSet.has(n)) || usadosRodada.has(n)) {
      continue;
    }
    usadosRodada.add(n);
    nums.push(n);
  }

  nums.sort((a,b)=>a-b);

  nums.forEach(n => {
    const lata = document.createElement("div");
    lata.className = "final-can";

    const logo = document.createElement("img");
    logo.src = "ball-logo.png";
    logo.className = "ball-logo";

    const num = document.createElement("div");
    num.className = "num";
    num.textContent = n;

    lata.appendChild(logo);
    lata.appendChild(num);

    arena.appendChild(lata);
  });

  const params = new URLSearchParams(window.location.search);

  if (noRepeatFlag) {
    usadosRodada.forEach(n => usedSet.add(n));
    const usadosStr = Array.from(usedSet).join(",");
    params.set("usados", usadosStr);
  } else {
    params.delete("usados");
  }

  nextSearch = "?" + params.toString();

  document.getElementById("retry").style.display = "inline-block";
  document.getElementById("reset").style.display = "inline-block";
  document.getElementById("back").style.display  = "inline-block";
}

function sortearDeNovo() {
  window.location.href = "resultado.html" + nextSearch;
}

/* BOT√ÉO **RESETAR** */
function resetar() {
  const params = new URLSearchParams(window.location.search);
  params.delete("usados");
  window.location.href = "resultado.html?" + params.toString();
}

function voltar() {
  window.location.href = "index.html";
}

iniciar();
</script>
</body>
</html>
